

# ---------------------------------------------------------------------------
# Simulated Data Store
# ---------------------------------------------------------------------------

class _DataStore:
    """
    In-memory data store simulating database access.
    In production this layer is replaced by PostgreSQL / MongoDB.
    """

    def __init__(self) -> None:
        self.homeworks: Dict[str, Homework] = {}
        self.submissions: Dict[str, HomeworkSubmission] = {}
        self.weekly_reports: Dict[str, WeeklyReport] = {}
        self.learning_goals: Dict[str, LearningGoal] = {}
        self.student_activity: Dict[str, List[Dict[str, Any]]] = {}
        self.class_rosters: Dict[str, List[str]] = {}
        self.question_bank: Dict[str, List[Dict[str, Any]]] = {}
        self.parent_children: Dict[str, List[str]] = {}
        self.parent_emails: Dict[str, str] = {}

    def get_student_activity(
        self, student_id: str, since: Optional[datetime] = None
    ) -> List[Dict[str, Any]]:
        """Ogrencinin aktivite kaydini dondurur."""
        activities = self.student_activity.get(student_id, [])
        if since:
            activities = [
                a for a in activities
                if a.get("timestamp", datetime.min) >= since
            ]
        return activities

    def get_class_students(self, class_id: str) -> List[str]:
        """Siniftaki ogrenci ID listesini dondurur."""
        return self.class_rosters.get(class_id, [])

    def get_student_name(self, student_id: str) -> str:
        """Placeholder - in production comes from user service."""
        return f"Ogrenci_{student_id[:6]}"

    def generate_questions_for_topics(
        self, topics: List[str], count: int
    ) -> List[Dict[str, Any]]:
        """
        Konulara gore soru uretir (simulasyon).
        Gercek uygulamada soru bankasindan veya AI ile uretilir.
        """
        questions: List[Dict[str, Any]] = []
        per_topic = max(1, count // len(topics))
        remaining = count - per_topic * len(topics)

        for idx, topic in enumerate(topics):
            topic_count = per_topic + (1 if idx < remaining else 0)
            for q_idx in range(topic_count):
                question_id = str(uuid.uuid4())
                questions.append({
                    "question_id": question_id,
                    "topic": topic,
                    "soru_metni": f"{topic} - Soru {q_idx + 1}",
                    "secenekler": ["A", "B", "C", "D"],
                    "dogru_cevap": "A",
                    "zorluk": "orta",
                    "puan": round(100 / count, 2),
                })
                if len(questions) >= count:
                    break
            if len(questions) >= count:
                break

        return questions[:count]


# Module-level shared store (replaced by DI in production)
_store = _DataStore()
