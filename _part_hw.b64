

# ---------------------------------------------------------------------------
# HomeworkService - Odev Yonetimi
# ---------------------------------------------------------------------------

class HomeworkService:
    """
    Odev olusturma, teslim alma ve otomatik degerlendirme servisi.
    Ogretmenler odev olusturur, ogrenciler teslim eder,
    sistem otomatik olarak degerlendirir.
    """

    def __init__(self, store: Optional[_DataStore] = None) -> None:
        self._store = store or _store

    # -- Public API --------------------------------------------------------

    def create_homework(
        self,
        teacher_id: str,
        class_id: str,
        topics: List[str],
        question_count: int,
        due_date: datetime,
        title: str,
    ) -> Homework:
        """
        Yeni odev olusturur ve sinifa atar.

        Args:
            teacher_id: Ogretmen kimligi.
            class_id: Sinif kimligi.
            topics: Konu listesi (or. ["Kesirler", "Ondalik Sayilar"]).
            question_count: Sorulacak soru adedi.
            due_date: Son teslim tarihi.
            title: Odev basligi.

        Returns:
            Olusturulan Homework nesnesi.

        Raises:
            ValueError: Gecersiz parametreler verildiginde.
        """
        if question_count <= 0:
            raise ValueError("Soru sayisi pozitif olmalidir.")
        if not topics:
            raise ValueError("En az bir konu belirtilmelidir.")
        if due_date <= datetime.utcnow():
            raise ValueError("Son teslim tarihi gelecekte olmalidir.")

        homework_id = str(uuid.uuid4())
        questions = self._store.generate_questions_for_topics(topics, question_count)
        students = self._store.get_class_students(class_id)

        homework = Homework(
            homework_id=homework_id,
            teacher_id=teacher_id,
            class_id=class_id,
            title=title,
            topics=topics,
            question_count=question_count,
            questions=questions,
            due_date=due_date,
            created_at=datetime.utcnow(),
            status=HomeworkStatus.ASSIGNED,
            toplam_ogrenci=len(students),
        )

        self._store.homeworks[homework_id] = homework
        return homework

    def get_homework(self, homework_id: str) -> Homework:
        """Odev detaylarini getirir."""
        if homework_id not in self._store.homeworks:
            raise KeyError(f"Odev bulunamadi: {homework_id}")
        homework = self._store.homeworks[homework_id]
        self._refresh_homework_status(homework)
        return homework

    def submit_homework(
        self,
        homework_id: str,
        student_id: str,
        answers: List[Dict[str, Any]],
    ) -> HomeworkSubmission:
        """
        Ogrenci odev teslimi yapar.

        Args:
            homework_id: Odev kimligi.
            student_id: Ogrenci kimligi.
            answers: Cevap listesi, her biri {"question_id": str, "answer": str} biciminde.

        Returns:
            HomeworkSubmission nesnesi.
        """
        homework = self.get_homework(homework_id)

        if homework.status == HomeworkStatus.CANCELLED:
            raise ValueError("Bu odev iptal edilmistir.")
        if datetime.utcnow() > homework.due_date:
            raise ValueError("Odev teslim suresi gecmistir.")

        existing = self._find_submission(homework_id, student_id)
        if existing is not None:
            raise ValueError("Bu odev zaten teslim edilmis.")

        submission_id = str(uuid.uuid4())
        submission = HomeworkSubmission(
            submission_id=submission_id,
            homework_id=homework_id,
            student_id=student_id,
            answers=answers,
            submitted_at=datetime.utcnow(),
        )

        self._store.submissions[submission_id] = submission
        homework.teslim_sayisi += 1
        if homework.status == HomeworkStatus.ASSIGNED:
            homework.status = HomeworkStatus.IN_PROGRESS
        return submission

    def grade_homework(self, homework_id: str) -> Dict[str, Any]:
        """Odeve ait tum teslimleri otomatik degerlendirir."""
        homework = self.get_homework(homework_id)
        submissions = self._get_homework_submissions(homework_id)

        if not submissions:
            return {
                "homework_id": homework_id,
                "graded_count": 0,
                "sinif_ortalamasi": 0.0,
                "en_yuksek_puan": 0.0,
                "en_dusuk_puan": 0.0,
                "submissions": [],
            }

        scores: List[float] = []
        for submission in submissions:
            self._grade_single_submission(submission, homework)
            if submission.score is not None:
                scores.append(submission.score)

        avg_score = statistics.mean(scores) if scores else 0.0
        homework.sinif_ortalamasi = round(avg_score, 2)
        homework.status = HomeworkStatus.GRADED

        return {
            "homework_id": homework_id,
            "graded_count": len(submissions),
            "sinif_ortalamasi": round(avg_score, 2),
            "en_yuksek_puan": max(scores) if scores else 0.0,
            "en_dusuk_puan": min(scores) if scores else 0.0,
            "submissions": submissions,
        }
