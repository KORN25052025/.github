
    def get_homework_results(self, homework_id: str) -> Dict[str, Any]:
        """Ogretmen icin odev sonuclarini dondurur."""
        homework = self.get_homework(homework_id)
        submissions = self._get_homework_submissions(homework_id)
        student_results: List[Dict[str, Any]] = []
        topic_totals: Dict[str, List[float]] = {}

        for sub in submissions:
            student_results.append({
                "student_id": sub.student_id,
                "student_name": self._store.get_student_name(sub.student_id),
                "score": sub.score, "dogru_sayisi": sub.dogru_sayisi,
                "yanlis_sayisi": sub.yanlis_sayisi, "bos_sayisi": sub.bos_sayisi,
                "submitted_at": sub.submitted_at.isoformat(),
                "topic_scores": sub.topic_scores,
            })
            for topic, score in sub.topic_scores.items():
                topic_totals.setdefault(topic, []).append(score)

        topic_analysis = [
            {"topic": topic, "ortalama": round(statistics.mean(vals), 2),
             "en_dusuk": round(min(vals), 2), "en_yuksek": round(max(vals), 2)}
            for topic, vals in topic_totals.items()
        ]
        teslim_orani = (homework.teslim_sayisi / homework.toplam_ogrenci * 100
                        if homework.toplam_ogrenci > 0 else 0.0)
        return {
            "homework_id": homework_id, "title": homework.title,
            "status": homework.status.value,
            "sinif_ortalamasi": homework.sinif_ortalamasi,
            "teslim_orani": round(teslim_orani, 1),
            "teslim_sayisi": homework.teslim_sayisi,
            "toplam_ogrenci": homework.toplam_ogrenci,
            "student_results": student_results,
            "topic_analysis": topic_analysis,
        }
